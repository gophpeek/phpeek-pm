name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    name: Build Release Binaries
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build all platforms
        run: make build-all VERSION=${{ steps.version.outputs.VERSION }}

      - name: Generate checksums
        run: |
          cd build
          sha256sum phpeek-pm-* > checksums.txt
          cat checksums.txt

      - name: Create release notes
        id: release_notes
        run: |
          cat > release-notes.md <<EOF
          # PHPeek Process Manager v${{ steps.version.outputs.VERSION }}

          ## Installation

          ### Linux AMD64
          \`\`\`bash
          wget https://github.com/gophpeek/phpeek-pm/releases/download/v${{ steps.version.outputs.VERSION }}/phpeek-pm-linux-amd64
          chmod +x phpeek-pm-linux-amd64
          sudo mv phpeek-pm-linux-amd64 /usr/local/bin/phpeek-pm
          \`\`\`

          ### Linux ARM64
          \`\`\`bash
          wget https://github.com/gophpeek/phpeek-pm/releases/download/v${{ steps.version.outputs.VERSION }}/phpeek-pm-linux-arm64
          chmod +x phpeek-pm-linux-arm64
          sudo mv phpeek-pm-linux-arm64 /usr/local/bin/phpeek-pm
          \`\`\`

          ### macOS AMD64 (Intel)
          \`\`\`bash
          wget https://github.com/gophpeek/phpeek-pm/releases/download/v${{ steps.version.outputs.VERSION }}/phpeek-pm-darwin-amd64
          chmod +x phpeek-pm-darwin-amd64
          sudo mv phpeek-pm-darwin-amd64 /usr/local/bin/phpeek-pm
          \`\`\`

          ### macOS ARM64 (Apple Silicon)
          \`\`\`bash
          wget https://github.com/gophpeek/phpeek-pm/releases/download/v${{ steps.version.outputs.VERSION }}/phpeek-pm-darwin-arm64
          chmod +x phpeek-pm-darwin-arm64
          sudo mv phpeek-pm-darwin-arm64 /usr/local/bin/phpeek-pm
          \`\`\`

          ## Verification

          Verify the checksums:
          \`\`\`bash
          wget https://github.com/gophpeek/phpeek-pm/releases/download/v${{ steps.version.outputs.VERSION }}/checksums.txt
          sha256sum -c checksums.txt
          \`\`\`

          ## Docker

          \`\`\`dockerfile
          COPY --from=gophpeek/phpeek-pm:v${{ steps.version.outputs.VERSION }} \\
              /usr/local/bin/phpeek-pm \\
              /usr/local/bin/phpeek-pm
          \`\`\`

          ## Documentation

          - [Getting Started](https://github.com/gophpeek/phpeek-pm/blob/main/docs/getting-started/quickstart.md)
          - [Configuration](https://github.com/gophpeek/phpeek-pm/blob/main/docs/configuration/overview.md)
          - [Examples](https://github.com/gophpeek/phpeek-pm/tree/main/configs/examples)

          ## Changelog

          See [CHANGELOG.md](https://github.com/gophpeek/phpeek-pm/blob/main/CHANGELOG.md) for details.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/phpeek-pm-linux-amd64
            build/phpeek-pm-linux-arm64
            build/phpeek-pm-darwin-amd64
            build/phpeek-pm-darwin-arm64
            build/checksums.txt
          body_path: release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: [build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "MAJOR=$(echo $VERSION | cut -d. -f1)" >> $GITHUB_OUTPUT
          echo "MINOR=$(echo $VERSION | cut -d. -f1,2)" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            gophpeek/phpeek-pm:latest
            gophpeek/phpeek-pm:${{ steps.version.outputs.VERSION }}
            gophpeek/phpeek-pm:${{ steps.version.outputs.MAJOR }}
            gophpeek/phpeek-pm:${{ steps.version.outputs.MINOR }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  test-release:
    name: Test Release Binaries
    runs-on: ${{ matrix.os }}
    needs: [build]
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            binary: phpeek-pm-linux-amd64
          - os: macos-latest
            binary: phpeek-pm-darwin-amd64

    steps:
      - name: Download release artifact
        uses: actions/download-artifact@v4
        with:
          name: binaries

      - name: Test binary
        run: |
          chmod +x ${{ matrix.binary }}
          ./${{ matrix.binary }} --version || true

          # Create minimal test config
          cat > test-config.yaml <<EOF
          version: "1.0"
          global:
            shutdown_timeout: 10
            log_level: info
          processes:
            sleeper:
              enabled: true
              command: ["sleep", "5"]
              priority: 10
              restart: never
          EOF

          # Run phpeek-pm in background
          PHPEEK_PM_CONFIG=test-config.yaml ./${{ matrix.binary }} &
          PID=$!

          # Wait for startup
          sleep 2

          # Check it's running
          kill -0 $PID

          # Graceful shutdown
          kill -TERM $PID
          wait $PID

          echo "âœ… Binary test passed"
