name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    name: Build Release Binaries
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build all platforms
        run: make build-all VERSION=${{ steps.version.outputs.VERSION }}

      - name: Generate checksums
        run: |
          cd build
          sha256sum phpeek-pm-* > checksums.txt
          cat checksums.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: build/phpeek-pm-*
          retention-days: 1

      - name: Create release notes
        id: release_notes
        run: |
          cat > release-notes.md <<EOF
          # PHPeek Process Manager v${{ steps.version.outputs.VERSION }}

          Production-grade PID 1 process manager for Docker containers with Laravel-first design.

          ## Features
          - Multi-process orchestration with DAG-based dependencies
          - Health checks (TCP, HTTP, Exec) with configurable thresholds
          - Restart policies with exponential backoff
          - Prometheus metrics export
          - Management REST API with authentication
          - Framework detection (Laravel, Symfony, WordPress)
          - Graceful shutdown and zombie reaping
          - Process scaling support

          ## Installation

          ### Linux AMD64
          \`\`\`bash
          wget https://github.com/gophpeek/phpeek-pm/releases/download/v${{ steps.version.outputs.VERSION }}/phpeek-pm-linux-amd64
          chmod +x phpeek-pm-linux-amd64
          sudo mv phpeek-pm-linux-amd64 /usr/local/bin/phpeek-pm
          \`\`\`

          ### Linux ARM64
          \`\`\`bash
          wget https://github.com/gophpeek/phpeek-pm/releases/download/v${{ steps.version.outputs.VERSION }}/phpeek-pm-linux-arm64
          chmod +x phpeek-pm-linux-arm64
          sudo mv phpeek-pm-linux-arm64 /usr/local/bin/phpeek-pm
          \`\`\`

          ### macOS AMD64 (Intel)
          \`\`\`bash
          wget https://github.com/gophpeek/phpeek-pm/releases/download/v${{ steps.version.outputs.VERSION }}/phpeek-pm-darwin-amd64
          chmod +x phpeek-pm-darwin-amd64
          sudo mv phpeek-pm-darwin-amd64 /usr/local/bin/phpeek-pm
          \`\`\`

          ### macOS ARM64 (Apple Silicon)
          \`\`\`bash
          wget https://github.com/gophpeek/phpeek-pm/releases/download/v${{ steps.version.outputs.VERSION }}/phpeek-pm-darwin-arm64
          chmod +x phpeek-pm-darwin-arm64
          sudo mv phpeek-pm-darwin-arm64 /usr/local/bin/phpeek-pm
          \`\`\`

          ## Verification

          Verify the checksums:
          \`\`\`bash
          wget https://github.com/gophpeek/phpeek-pm/releases/download/v${{ steps.version.outputs.VERSION }}/checksums.txt
          sha256sum -c checksums.txt
          \`\`\`

          ## Docker

          Docker images are available on GitHub Container Registry:
          \`\`\`bash
          docker pull ghcr.io/gophpeek/phpeek-pm:v${{ steps.version.outputs.VERSION }}
          # or
          docker pull ghcr.io/gophpeek/phpeek-pm:latest
          \`\`\`

          Use in your Dockerfile:
          \`\`\`dockerfile
          FROM ghcr.io/gophpeek/phpeek-pm:v${{ steps.version.outputs.VERSION }}
          COPY phpeek-pm.yaml /etc/phpeek-pm/phpeek-pm.yaml
          \`\`\`

          Or copy binary from release:
          \`\`\`dockerfile
          FROM alpine:3.19
          RUN apk add --no-cache ca-certificates tzdata wget
          RUN wget -O /usr/local/bin/phpeek-pm \\
              https://github.com/gophpeek/phpeek-pm/releases/download/v${{ steps.version.outputs.VERSION }}/phpeek-pm-linux-amd64 && \\
              chmod +x /usr/local/bin/phpeek-pm
          ENTRYPOINT ["/usr/local/bin/phpeek-pm"]
          \`\`\`

          ## Documentation

          - [Getting Started](https://github.com/gophpeek/phpeek-pm/blob/main/docs/getting-started/quickstart.md)
          - [Installation Guide](https://github.com/gophpeek/phpeek-pm/blob/main/docs/getting-started/installation.md)
          - [Docker Integration](https://github.com/gophpeek/phpeek-pm/blob/main/docs/getting-started/docker-integration.md)
          - [Configuration Examples](https://github.com/gophpeek/phpeek-pm/tree/main/configs/examples)
          - [Prometheus Metrics](https://github.com/gophpeek/phpeek-pm/blob/main/docs/observability/metrics.md)
          - [Management API](https://github.com/gophpeek/phpeek-pm/blob/main/docs/observability/api.md)

          ## Quick Start

          Create a minimal configuration:
          \`\`\`yaml
          version: "1.0"
          global:
            shutdown_timeout: 30
            log_level: info

          processes:
            php-fpm:
              enabled: true
              command: ["php-fpm", "-F", "-R"]
              priority: 10
              restart: always
          \`\`\`

          Run:
          \`\`\`bash
          phpeek-pm --config phpeek-pm.yaml
          \`\`\`
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/phpeek-pm-linux-amd64
            build/phpeek-pm-linux-arm64
            build/phpeek-pm-darwin-amd64
            build/phpeek-pm-darwin-arm64
            build/checksums.txt
          body_path: release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "MAJOR=$(echo $VERSION | cut -d. -f1)" >> $GITHUB_OUTPUT
          echo "MINOR=$(echo $VERSION | cut -d. -f1,2)" >> $GITHUB_OUTPUT

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ steps.version.outputs.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  test-release:
    name: Test Release Binaries
    runs-on: ${{ matrix.os }}
    needs: [build]
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            binary: phpeek-pm-linux-amd64
          - os: macos-latest
            binary: phpeek-pm-darwin-amd64

    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries

      - name: Test binary
        run: |
          chmod +x ${{ matrix.binary }}
          ./${{ matrix.binary }} --version || true

          # Create minimal test config
          cat > test-config.yaml <<EOF
          version: "1.0"
          global:
            shutdown_timeout: 10
            log_level: info
          processes:
            sleeper:
              enabled: true
              command: ["sleep", "5"]
              priority: 10
              restart: never
          EOF

          # Run phpeek-pm in background
          PHPEEK_PM_CONFIG=test-config.yaml ./${{ matrix.binary }} &
          PID=$!

          # Wait for startup
          sleep 2

          # Check it's running
          if kill -0 $PID 2>/dev/null; then
            echo "✅ Process is running"
          else
            echo "❌ Process failed to start"
            exit 1
          fi

          # Graceful shutdown
          kill -TERM $PID
          wait $PID || true

          echo "✅ Binary test passed"
