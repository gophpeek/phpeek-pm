# Docker Compose example with PHP-FPM auto-tuning
# Shows different profiles for different environments

version: "3.8"

services:
  # Development environment - minimal resources
  app-dev:
    image: myapp:latest
    environment:
      - PHP_FPM_AUTOTUNE_PROFILE=dev
      - APP_ENV=local
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1'
    volumes:
      - ./:/var/www/html
    ports:
      - "8000:80"

  # Staging environment - medium profile
  app-staging:
    image: myapp:latest
    environment:
      - PHP_FPM_AUTOTUNE_PROFILE=medium
      - APP_ENV=staging
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
    ports:
      - "8001:80"

  # Production environment - heavy profile
  app-production:
    image: myapp:latest
    environment:
      - PHP_FPM_AUTOTUNE_PROFILE=heavy
      - APP_ENV=production
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '8'
      replicas: 3
    ports:
      - "8002:80"

  # Bursty traffic environment (e-commerce, events)
  app-bursty:
    image: myapp:latest
    environment:
      - PHP_FPM_AUTOTUNE_PROFILE=bursty
      - APP_ENV=production
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '4'
      replicas: 2
    ports:
      - "8003:80"

  # Override via CLI flag (for testing)
  app-cli-override:
    image: myapp:latest
    environment:
      - PHP_FPM_AUTOTUNE_PROFILE=light  # ENV sets light
    command:
      - "phpeek-pm"
      - "--php-fpm-profile=heavy"  # CLI overrides to heavy
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '4'
