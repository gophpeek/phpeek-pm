version: "1.0"

# TLS/HTTPS Configuration Example
# This example demonstrates how to enable TLS for API and metrics endpoints

global:
  shutdown_timeout: 30
  log_level: info
  log_format: json

  # API Configuration with TLS
  api_enabled: true
  api_port: 8443  # HTTPS port
  api_auth: "your-secret-token-here"

  # TLS Configuration for API Server
  api_tls:
    enabled: true
    cert_file: "/etc/phpeek-pm/certs/server.crt"
    key_file: "/etc/phpeek-pm/certs/server.key"
    # Optional: CA certificate for mutual TLS (mTLS)
    # ca_file: "/etc/phpeek-pm/certs/ca.crt"
    # Client authentication: none | request | require | verify
    client_auth: "none"
    # Minimum TLS version: TLS 1.0 | TLS 1.1 | TLS 1.2 | TLS 1.3
    min_version: "TLS 1.2"
    # Optional: Specify allowed cipher suites
    # cipher_suites:
    #   - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
    #   - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
    #   - "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256"
    #   - "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384"
    # Auto-reload certificates when they change (e.g., after renewal)
    auto_reload: true
    auto_reload_interval: 300  # Check every 5 minutes

  # Metrics Configuration with TLS
  metrics_enabled: true
  metrics_port: 9443  # HTTPS port for metrics
  metrics_path: "/metrics"

  # TLS Configuration for Metrics Server
  metrics_tls:
    enabled: true
    cert_file: "/etc/phpeek-pm/certs/metrics.crt"
    key_file: "/etc/phpeek-pm/certs/metrics.key"
    # Can use same or different certificates than API
    client_auth: "none"
    min_version: "TLS 1.2"
    auto_reload: true
    auto_reload_interval: 300

processes:
  php-fpm:
    enabled: true
    command: ["php-fpm", "-F", "-R"]
    restart: always
    scale: 1

  nginx:
    enabled: true
    command: ["nginx", "-g", "daemon off;"]
    restart: always
    scale: 1
    depends_on: [php-fpm]

# Example: Mutual TLS (mTLS) Configuration
# Uncomment and configure for client certificate authentication

# global:
#   api_tls:
#     enabled: true
#     cert_file: "/etc/phpeek-pm/certs/server.crt"
#     key_file: "/etc/phpeek-pm/certs/server.key"
#     ca_file: "/etc/phpeek-pm/certs/ca.crt"  # CA that signed client certs
#     client_auth: "verify"  # Require and verify client certificates
#     min_version: "TLS 1.3"

# Example: Self-Signed Certificate Generation
# For testing purposes, generate self-signed certificates:
#
# # Generate CA
# openssl genrsa -out ca.key 4096
# openssl req -new -x509 -days 365 -key ca.key -out ca.crt
#
# # Generate server certificate
# openssl genrsa -out server.key 2048
# openssl req -new -key server.key -out server.csr
# openssl x509 -req -days 365 -in server.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out server.crt
#
# # For production, use certificates from a trusted CA like Let's Encrypt

# Example: Let's Encrypt with Certbot
# For production with Let's Encrypt:
#
# 1. Install Certbot:
#    apt-get install certbot
#
# 2. Obtain certificates:
#    certbot certonly --standalone -d your-domain.com
#
# 3. Configure PHPeek PM:
#    cert_file: "/etc/letsencrypt/live/your-domain.com/fullchain.pem"
#    key_file: "/etc/letsencrypt/live/your-domain.com/privkey.pem"
#    auto_reload: true  # Automatically reload after renewal
#
# 4. Setup auto-renewal:
#    certbot renew --deploy-hook "systemctl reload phpeek-pm"
